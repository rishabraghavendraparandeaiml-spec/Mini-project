<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Location Test - Debug Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .test-result {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        .success { border-color: #28a745; background-color: #d4edda; }
        .error { border-color: #dc3545; background-color: #f8d7da; }
        .warning { border-color: #ffc107; background-color: #fff3cd; }
        .info { border-color: #17a2b8; background-color: #d1ecf1; }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">üó∫Ô∏è Location Debug Tool</h1>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>üìã System Check</h5>
                    </div>
                    <div class="card-body">
                        <div id="systemTests"></div>
                        <button class="btn btn-primary" onclick="runSystemTests()">
                            <i class="fas fa-play"></i> Run System Tests
                        </button>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h5>üéØ Location Test</h5>
                    </div>
                    <div class="card-body">
                        <div id="locationResults"></div>
                        <button class="btn btn-success" onclick="testLocation()">
                            <i class="fas fa-location-arrow"></i> Test My Location
                        </button>
                        <button class="btn btn-info ms-2" onclick="runContinuousTest()">
                            <i class="fas fa-sync"></i> Continuous Test
                        </button>
                        <button class="btn btn-warning ms-2" onclick="stopTests()">
                            <i class="fas fa-stop"></i> Stop
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>üìä Results Log</h5>
                    </div>
                    <div class="card-body">
                        <pre id="logOutput" style="height: 400px; overflow-y: scroll;"></pre>
                        <button class="btn btn-secondary btn-sm" onclick="clearLog()">Clear Log</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>üîß Quick Fixes</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <h6>üîí Permission Issues</h6>
                                <ul class="small">
                                    <li>Click lock icon in address bar</li>
                                    <li>Allow location access</li>
                                    <li>Refresh page after allowing</li>
                                </ul>
                            </div>
                            <div class="col-md-4">
                                <h6>üì± Device Settings</h6>
                                <ul class="small">
                                    <li>Enable location services</li>
                                    <li>Check GPS/WiFi is on</li>
                                    <li>Try different browser</li>
                                </ul>
                            </div>
                            <div class="col-md-4">
                                <h6>üåê Network Issues</h6>
                                <ul class="small">
                                    <li>Use HTTPS if possible</li>
                                    <li>Check internet connection</li>
                                    <li>Disable VPN temporarily</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let continuousTestId = null;
        let testCount = 0;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logOutput = document.getElementById('logOutput');
            const color = {
                'success': '#28a745',
                'error': '#dc3545', 
                'warning': '#ffc107',
                'info': '#17a2b8'
            }[type] || '#000';
            
            logOutput.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
            logOutput.scrollTop = logOutput.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }
        
        function clearLog() {
            document.getElementById('logOutput').innerHTML = '';
        }
        
        function addResult(containerId, title, status, details) {
            const container = document.getElementById(containerId);
            const resultClass = status === 'success' ? 'success' : 
                               status === 'error' ? 'error' : 
                               status === 'warning' ? 'warning' : 'info';
            
            const icon = status === 'success' ? '‚úÖ' : 
                        status === 'error' ? '‚ùå' : 
                        status === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            
            container.innerHTML += `
                <div class="test-result ${resultClass}">
                    <strong>${icon} ${title}</strong>
                    <div>${details}</div>
                </div>
            `;
        }
        
        function runSystemTests() {
            document.getElementById('systemTests').innerHTML = '';
            log('üîÑ Running system tests...', 'info');
            
            // Test 1: Geolocation API Support
            if (navigator.geolocation) {
                addResult('systemTests', 'Geolocation API', 'success', 'Browser supports geolocation');
                log('‚úÖ Geolocation API supported', 'success');
            } else {
                addResult('systemTests', 'Geolocation API', 'error', 'Browser does not support geolocation');
                log('‚ùå Geolocation API not supported', 'error');
                return;
            }
            
            // Test 2: Secure Context
            const isSecure = window.isSecureContext || window.location.protocol === 'https:' || 
                           window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
            
            if (isSecure) {
                addResult('systemTests', 'Security Context', 'success', 'Running in secure context (HTTPS/localhost)');
                log('‚úÖ Secure context verified', 'success');
            } else {
                addResult('systemTests', 'Security Context', 'warning', 'Not in secure context - location may be less accurate');
                log('‚ö†Ô∏è Not in secure context', 'warning');
            }
            
            // Test 3: Permission API
            if ('permissions' in navigator) {
                navigator.permissions.query({ name: 'geolocation' }).then(permission => {
                    const status = permission.state;
                    const statusType = status === 'granted' ? 'success' : 
                                     status === 'denied' ? 'error' : 'warning';
                    
                    addResult('systemTests', 'Location Permission', statusType, 
                             `Permission status: ${status.toUpperCase()}`);
                    log(`üîê Permission status: ${status}`, statusType);
                }).catch(error => {
                    addResult('systemTests', 'Location Permission', 'warning', 'Could not check permission status');
                    log('‚ö†Ô∏è Could not check permissions', 'warning');
                });
            } else {
                addResult('systemTests', 'Permission API', 'info', 'Permission API not available');
                log('‚ÑπÔ∏è Permission API not available', 'info');
            }
            
            // Test 4: User Agent Info
            const userAgent = navigator.userAgent;
            const browser = getBrowserInfo(userAgent);
            addResult('systemTests', 'Browser Info', 'info', `${browser.name} ${browser.version}`);
            log(`üåê Browser: ${browser.name} ${browser.version}`, 'info');
        }
        
        function getBrowserInfo(userAgent) {
            if (userAgent.includes('Chrome')) return { name: 'Chrome', version: 'Latest' };
            if (userAgent.includes('Firefox')) return { name: 'Firefox', version: 'Latest' };
            if (userAgent.includes('Safari')) return { name: 'Safari', version: 'Latest' };
            if (userAgent.includes('Edge')) return { name: 'Edge', version: 'Latest' };
            return { name: 'Unknown', version: 'Unknown' };
        }
        
        function testLocation() {
            testCount++;
            document.getElementById('locationResults').innerHTML = '';
            log(`üéØ Starting location test #${testCount}...`, 'info');
            
            addResult('locationResults', 'Location Test', 'info', 
                     '<span class="loading"></span> Getting your location...');
            
            const options = {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 0
            };
            
            const startTime = Date.now();
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const endTime = Date.now();
                    const duration = endTime - startTime;
                    
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const accuracy = Math.round(position.coords.accuracy);
                    const speed = position.coords.speed;
                    const heading = position.coords.heading;
                    const altitude = position.coords.altitude;
                    
                    document.getElementById('locationResults').innerHTML = '';
                    
                    addResult('locationResults', 'Location Found!', 'success', `
                        <strong>Coordinates:</strong> ${lat.toFixed(6)}, ${lng.toFixed(6)}<br>
                        <strong>Accuracy:</strong> ¬±${accuracy}m<br>
                        <strong>Speed:</strong> ${speed ? Math.round(speed) + ' m/s' : 'Unknown'}<br>
                        <strong>Heading:</strong> ${heading ? Math.round(heading) + '¬∞' : 'Unknown'}<br>
                        <strong>Altitude:</strong> ${altitude ? Math.round(altitude) + 'm' : 'Unknown'}<br>
                        <strong>Time taken:</strong> ${duration}ms
                    `);
                    
                    log(`‚úÖ Location found: ${lat.toFixed(6)}, ${lng.toFixed(6)} (¬±${accuracy}m) in ${duration}ms`, 'success');
                    
                    // Quality assessment
                    let quality, qualityType;
                    if (accuracy <= 10) {
                        quality = 'Excellent GPS signal';
                        qualityType = 'success';
                    } else if (accuracy <= 50) {
                        quality = 'Good GPS signal';
                        qualityType = 'success';
                    } else if (accuracy <= 100) {
                        quality = 'Fair GPS signal';
                        qualityType = 'warning';
                    } else {
                        quality = 'Poor GPS signal - try moving outdoors';
                        qualityType = 'warning';
                    }
                    
                    addResult('locationResults', 'Signal Quality', qualityType, quality);
                    log(`üì∂ Signal quality: ${quality}`, qualityType);
                },
                (error) => {
                    const endTime = Date.now();
                    const duration = endTime - startTime;
                    
                    document.getElementById('locationResults').innerHTML = '';
                    
                    let errorMessage, solution;
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage = 'Location access denied by user';
                            solution = 'Click the location icon in address bar and allow location access';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage = 'Location information unavailable';
                            solution = 'Check if location services are enabled on your device';
                            break;
                        case error.TIMEOUT:
                            errorMessage = 'Location request timed out';
                            solution = 'Try again or move to an area with better GPS signal';
                            break;
                        default:
                            errorMessage = 'Unknown location error';
                            solution = 'Try refreshing the page or using a different browser';
                            break;
                    }
                    
                    addResult('locationResults', 'Location Failed', 'error', `
                        <strong>Error:</strong> ${errorMessage}<br>
                        <strong>Code:</strong> ${error.code}<br>
                        <strong>Time taken:</strong> ${duration}ms<br>
                        <strong>Solution:</strong> ${solution}
                    `);
                    
                    log(`‚ùå Location error: ${errorMessage} (Code: ${error.code}) after ${duration}ms`, 'error');
                },
                options
            );
        }
        
        function runContinuousTest() {
            if (continuousTestId) {
                stopTests();
            }
            
            log('üîÑ Starting continuous location test...', 'info');
            continuousTestId = setInterval(() => {
                testLocation();
            }, 5000);
        }
        
        function stopTests() {
            if (continuousTestId) {
                clearInterval(continuousTestId);
                continuousTestId = null;
                log('‚èπÔ∏è Continuous test stopped', 'info');
            }
        }
        
        // Auto-run system tests on load
        window.onload = function() {
            log('üöÄ Location Debug Tool loaded', 'success');
            setTimeout(runSystemTests, 500);
        };
    </script>
</body>
</html>